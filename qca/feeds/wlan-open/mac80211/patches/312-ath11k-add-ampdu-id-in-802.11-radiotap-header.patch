From 3f962ed9a4079964c48e321fd928a2719038d881 Mon Sep 17 00:00:00 2001
From: P Praneesh <ppranees@codeaurora.org>
Date: Fri, 28 May 2021 23:53:57 +0530
Subject: [PATCH] ath11k: add ampdu id in 802.11 radiotap header

AMPDU aggregate reference number is generated by
driver internally which is same across each
subframe of an ampdu.

For fetching AMPDU-ID, we need to concatenate
ppdu_id from mpdu_info and tlv_usr from tlv heder.
while parsing monitor TLV data with HAL_RX_MPDU_START
TLV tag, ampdu id is fetched from mpdu_info and
updated to corresponding mac80211 structure during
ath11k_update_radiotap.

Signed-off-by: P Praneesh <ppranees@codeaurora.org>
---
 drivers/net/wireless/ath/ath11k/dp_rx.c  |  6 ++++++
 drivers/net/wireless/ath/ath11k/hal_rx.c | 13 ++++++++++++
 drivers/net/wireless/ath/ath11k/hal_rx.h | 16 ++++++++------
 drivers/net/wireless/ath/ath11k/hw.c     | 36 +++++++++++++++++++++++++-------
 drivers/net/wireless/ath/ath11k/hw.h     |  1 +
 5 files changed, 58 insertions(+), 14 deletions(-)

--- a/drivers/net/wireless/ath/ath11k/dp_rx.c
+++ b/drivers/net/wireless/ath/ath11k/dp_rx.c
@@ -5968,6 +5968,7 @@ static void ath11k_update_radiotap(struc
 {
 	struct ieee80211_supported_band *sband;
 	u8 *ptr = NULL;
+	u16 ampdu_id = ppduinfo->ampdu_id[ppduinfo->userid];
 
 	rxs->flag |= RX_FLAG_MACTIME_START;
 	rxs->signal = ppduinfo->rssi_comb + ATH11K_DEFAULT_NOISE_FLOOR;
@@ -5978,6 +5979,11 @@ static void ath11k_update_radiotap(struc
 	 */
 	rxs->nss = ppduinfo->nss ? ppduinfo->nss : ppduinfo->nss + 1;
 
+	if (ampdu_id) {
+		rxs->flag |= RX_FLAG_AMPDU_DETAILS;
+		rxs->ampdu_reference = ampdu_id;
+	}
+
 	if (ppduinfo->he_mu_flags) {
 		rxs->flag |= RX_FLAG_RADIOTAP_HE_MU;
 		rxs->encoding = RX_ENC_HE;
--- a/drivers/net/wireless/ath/ath11k/hal_rx.c
+++ b/drivers/net/wireless/ath/ath11k/hal_rx.c
@@ -867,6 +867,13 @@ ath11k_hal_rx_populate_mu_user_info(void
 	ath11k_hal_rx_populate_byte_count(rx_tlv, ppdu_info, rx_user_status);
 }
 
+static
+u16 ath11k_hal_rxdesc_get_hal_mpdu_ppdu_id(struct ath11k_base *ab,
+					   struct hal_rx_mpdu_info *mpdu_info)
+{
+	return ab->hw_params.hw_ops->rx_desc_get_hal_ppdu_id(mpdu_info);
+}
+
 static enum hal_rx_mon_status
 ath11k_hal_rx_parse_mon_status_tlv(struct ath11k_base *ab,
 				   struct hal_rx_mon_ppdu_info *ppdu_info,
@@ -1521,6 +1530,12 @@ ath11k_hal_rx_parse_mon_status_tlv(struc
 			ppdu_info->peer_id = peer_id;
 
 		ppdu_info->mpdu_len += ab->hw_params.hw_ops->rx_desc_get_hal_mpdu_len(tlv_data);
+
+		if (userid < HAL_MAX_UL_MU_USERS) {
+			ppdu_info->userid = userid;
+			ppdu_info->ampdu_id[userid] =
+				ath11k_hal_rxdesc_get_hal_mpdu_ppdu_id(ab, mpdu_info);
+		}
 		break;
 	}
 	case HAL_RXPCU_PPDU_END_INFO: {
--- a/drivers/net/wireless/ath/ath11k/hal_rx.h
+++ b/drivers/net/wireless/ath/ath11k/hal_rx.h
@@ -222,6 +222,8 @@ struct hal_rx_mon_ppdu_info {
 	u32 num_users;
 	u32 mpdu_fcs_ok_bitmap[HAL_RX_NUM_WORDS_PER_PPDU_BITMAP];
 	struct hal_rx_user_status userstats[HAL_MAX_UL_MU_USERS];
+	u8 userid;
+	u16 ampdu_id[HAL_MAX_UL_MU_USERS];
 };
 
 #define HAL_RX_UL_OFDMA_USER_INFO_V0_W0_VALID			BIT(30)
@@ -443,15 +445,16 @@ struct hal_rx_phyrx_rssi_legacy_info {
 	__le32 info0;
 } __packed;
 
-#define HAL_RX_MPDU_INFO_INFO0_PEERID	GENMASK(31, 16)
 #define HAL_RX_MPDU_INFO_INFO0_PEERID_WCN6855	GENMASK(15, 0)
-#define HAL_RX_MPDU_INFO_INFO1_MPDU_LEN        GENMASK(13, 0)
+#define HAL_RX_MPDU_INFO_INFO0_PPDU_ID	GENMASK(31, 16)
+#define HAL_RX_MPDU_INFO_INFO1_PEERID	GENMASK(31, 16)
+#define HAL_RX_MPDU_INFO_INFO2_MPDU_LEN	GENMASK(13, 0)
 
 struct hal_rx_mpdu_info {
-	__le32 rsvd0;
 	__le32 info0;
-	__le32 rsvd1[11];
 	__le32 info1;
+	__le32 rsvd1[11];
+	__le32 info2;
 	__le32 rsvd2[9];
 } __packed;
 
@@ -462,10 +465,11 @@ struct hal_rx_mpdu_info_wcn6855 {
 } __packed;
 
 struct hal_rx_mpdu_info_qcn9074 {
-	__le32 rsvd0[10];
+	__le32 rsvd0[9];
 	__le32 info0;
-	__le32 rsvd1[2];
 	__le32 info1;
+	__le32 rsvd1[2];
+	__le32 info2;
 	__le32 rsvd2[9];
 } __packed;
 
--- a/drivers/net/wireless/ath/ath11k/hw.h
+++ b/drivers/net/wireless/ath/ath11k/hw.h
@@ -283,6 +283,7 @@ struct ath11k_hw_ops {
 	void (*fill_cfr_hdr_info)(struct ath11k *ar,
 				  struct ath11k_csi_cfr_header *header,
 				  struct ath11k_cfr_peer_tx_param *params);
+	u16 (*rx_desc_get_hal_ppdu_id) (struct hal_rx_mpdu_info *mpdu_info);
 };
 
 extern const struct ath11k_hw_ops ipq8074_ops;
--- a/drivers/net/wireless/ath/ath11k/hw.c
+++ b/drivers/net/wireless/ath/ath11k/hw.c
@@ -13,6 +13,7 @@
 #include "hal.h"
 #include "hw.h"
 #include "hif.h"
+#include "hal_rx.h"
 
 /* Map from pdev index to hw mac index */
 static u8 ath11k_hw_ipq8074_mac_from_pdev_id(int pdev_idx)
@@ -986,16 +987,14 @@ static void ath11k_hw_ipq5018_reo_setup(
 	ath11k_hal_reo_hash_setup(ab, ring_hash_map);
 }
 
-static u16 ath11k_hw_ipq8074_mpdu_info_get_peerid(u8 *tlv_data)
+static
+u16 ath11k_hw_ipq8074_rx_desc_get_hal_mpdu_ppdu_id(u8 *tlv_data)
 {
-	u16 peer_id = 0;
 	struct hal_rx_mpdu_info *mpdu_info =
 		(struct hal_rx_mpdu_info *)tlv_data;
 
-	peer_id = FIELD_GET(HAL_RX_MPDU_INFO_INFO0_PEERID,
-			    __le32_to_cpu(mpdu_info->info0));
-
-	return peer_id;
+	return FIELD_GET(HAL_RX_MPDU_INFO_INFO0_PPDU_ID,
+			 __le32_to_cpu(mpdu_info->info0));
 }
 
 static
@@ -1004,8 +1003,40 @@ u32 ath11k_hw_ipq8074_rx_desc_get_hal_mp
 	struct hal_rx_mpdu_info *mpdu_info =
 		(struct hal_rx_mpdu_info *)tlv_data;
 
-	return FIELD_GET(HAL_RX_MPDU_INFO_INFO1_MPDU_LEN,
-			 __le32_to_cpu(mpdu_info->u.ipq8074.info1));
+	return FIELD_GET(HAL_RX_MPDU_INFO_INFO2_MPDU_LEN,
+			 __le32_to_cpu(mpdu_info->info2));
+}
+
+static
+u16 ath11k_hw_qcn9074_rx_desc_get_hal_mpdu_ppdu_id(u8 *tlv_data)
+{
+	struct hal_rx_mpdu_info_qcn9074 *mpdu_info =
+		(struct hal_rx_mpdu_info_ipq9074 *)tlv_data;
+
+	return FIELD_GET(HAL_RX_MPDU_INFO_INFO0_PPDU_ID,
+			 __le32_to_cpu(mpdu_info->info0));
+}
+
+static
+u32 ath11k_hw_qcn9074_rx_desc_get_hal_mpdu_len(u8 *tlv_data)
+{
+	struct hal_rx_mpdu_info_qcn9074 *mpdu_info =
+		(struct hal_rx_mpdu_info_qcn9074 *)tlv_data;
+
+	return FIELD_GET(HAL_RX_MPDU_INFO_INFO2_MPDU_LEN,
+			 __le32_to_cpu(mpdu_info->info2));
+}
+
+static u16 ath11k_hw_ipq8074_mpdu_info_get_peerid(u8 *tlv_data)
+{
+	u16 peer_id = 0;
+	struct hal_rx_mpdu_info *mpdu_info =
+		(struct hal_rx_mpdu_info *)tlv_data;
+
+	peer_id = FIELD_GET(HAL_RX_MPDU_INFO_INFO1_PEERID,
+			    __le32_to_cpu(mpdu_info->info1));
+
+	return peer_id;
 }
 
 static u16 ath11k_hw_wcn6855_mpdu_info_get_peerid(u8 *tlv_data)
@@ -1024,21 +1055,10 @@ static u16 ath11k_hw_qcn9074_mpdu_info_g
 	struct hal_rx_mpdu_info_qcn9074 *mpdu_info =
 		(struct hal_rx_mpdu_info_qcn9074 *)tlv_data;
 
-	return FIELD_GET(HAL_RX_MPDU_INFO_INFO0_PEERID,
-			 __le32_to_cpu(mpdu_info->u.qcn9074.info0));
+	return FIELD_GET(HAL_RX_MPDU_INFO_INFO1_PEERID,
+			 __le32_to_cpu(mpdu_info->info1));
 }
 
-static
-u32 ath11k_hw_qcn9074_rx_desc_get_hal_mpdu_len(u8 *tlv_data)
-{
-	struct hal_rx_mpdu_info_qcn9074 *mpdu_info =
-		(struct hal_rx_mpdu_info_qcn9074 *)tlv_data;
-
-	return FIELD_GET(HAL_RX_MPDU_INFO_INFO1_MPDU_LEN,
-			 __le32_to_cpu(mpdu_info->u.qcn9074.info1));
-}
-
-
 static void ath11k_hw_ipq5018_set_rx_fragmentation_dst_ring(struct ath11k_base *ab)
 {
 	u8 frag_dst_ring = HAL_SRNG_RING_ID_REO2SW1;
@@ -1312,6 +1332,7 @@ const struct ath11k_hw_ops ipq8074_ops =
 	.rx_desc_get_dot11_hdr = ath11k_hw_ipq8074_rx_desc_get_dot11_hdr,
 	.rx_desc_get_crypto_header = ath11k_hw_ipq8074_rx_desc_get_crypto_hdr,
 	.fill_cfr_hdr_info = ath11k_hw_ipq8074_fill_cfr_hdr_info,
+	.rx_desc_get_hal_ppdu_id = ath11k_hw_ipq8074_rx_desc_get_hal_mpdu_ppdu_id,
 };
 
 const struct ath11k_hw_ops ipq6018_ops = {
@@ -1361,6 +1382,7 @@ const struct ath11k_hw_ops ipq6018_ops =
 	.rx_desc_dot11_hdr_fields_valid = ath11k_hw_ipq8074_rx_desc_dot11_hdr_fields_valid,
 	.rx_desc_get_dot11_hdr = ath11k_hw_ipq8074_rx_desc_get_dot11_hdr,
 	.rx_desc_get_crypto_header = ath11k_hw_ipq8074_rx_desc_get_crypto_hdr,
+	.rx_desc_get_hal_ppdu_id = ath11k_hw_ipq8074_rx_desc_get_hal_mpdu_ppdu_id,
 };
 
 const struct ath11k_hw_ops qca6390_ops = {
@@ -1410,6 +1432,7 @@ const struct ath11k_hw_ops qca6390_ops =
 	.rx_desc_dot11_hdr_fields_valid = ath11k_hw_ipq8074_rx_desc_dot11_hdr_fields_valid,
 	.rx_desc_get_dot11_hdr = ath11k_hw_ipq8074_rx_desc_get_dot11_hdr,
 	.rx_desc_get_crypto_header = ath11k_hw_ipq8074_rx_desc_get_crypto_hdr,
+	.rx_desc_get_hal_ppdu_id = ath11k_hw_ipq8074_rx_desc_get_hal_mpdu_ppdu_id,
 };
 
 const struct ath11k_hw_ops qcn9074_ops = {
@@ -1463,6 +1486,7 @@ const struct ath11k_hw_ops qcn9074_ops =
 	.rx_desc_get_dot11_hdr = ath11k_hw_qcn9074_rx_desc_get_dot11_hdr,
 	.rx_desc_get_crypto_header = ath11k_hw_qcn9074_rx_desc_get_crypto_hdr,
 	.fill_cfr_hdr_info = ath11k_hw_qcn9074_fill_cfr_hdr_info,
+	.rx_desc_get_hal_ppdu_id = ath11k_hw_qcn9074_rx_desc_get_hal_mpdu_ppdu_id,
 };
 
 const struct ath11k_hw_ops wcn6855_ops = {
@@ -1504,6 +1528,7 @@ const struct ath11k_hw_ops wcn6855_ops =
 	.set_rx_fragmentation_dst_ring = ath11k_hw_wcn6855_set_rx_fragmentation_dst_ring,
 	.get_reo_dest_remap_config = ath11k_get_reo_dest_remap_config_default,
 	.rx_desc_get_hal_mpdu_len = ath11k_hw_ipq8074_rx_desc_get_hal_mpdu_len,
+	.rx_desc_get_hal_ppdu_id = ath11k_hw_ipq8074_rx_desc_get_hal_mpdu_ppdu_id,
 };
 
 /* IPQ5018 hw ops is similar to QCN9074 except for the dest ring remap */
@@ -1547,6 +1572,7 @@ const struct ath11k_hw_ops ipq5018_ops =
 	.get_reo_dest_remap_config = ath11k_get_reo_dest_remap_config_5018,
 	.mpdu_info_get_peerid = ath11k_hw_ipq8074_mpdu_info_get_peerid,
 	.rx_desc_get_hal_mpdu_len = ath11k_hw_qcn9074_rx_desc_get_hal_mpdu_len,
+	.rx_desc_get_hal_ppdu_id = ath11k_hw_qcn9074_rx_desc_get_hal_mpdu_ppdu_id,
  };
 
 const struct ath11k_hw_ops qcn6122_ops = {
@@ -1602,6 +1628,7 @@ const struct ath11k_hw_ops qcn6122_ops =
 	.rx_desc_dot11_hdr_fields_valid = ath11k_hw_qcn9074_rx_desc_dot11_hdr_fields_valid,
 	.rx_desc_get_dot11_hdr = ath11k_hw_qcn9074_rx_desc_get_dot11_hdr,
 	.rx_desc_get_crypto_header = ath11k_hw_qcn9074_rx_desc_get_crypto_hdr,
+	.rx_desc_get_hal_ppdu_id = ath11k_hw_qcn9074_rx_desc_get_hal_mpdu_ppdu_id,
 };
 
 #define ATH11K_TX_RING_MASK_0 0x1
