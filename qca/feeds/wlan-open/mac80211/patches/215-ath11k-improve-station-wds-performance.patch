From: Karthikeyan Periyasamy <periyasa@codeaurora.org>

ath11k: Improve wds performance on station mode

In UL data traffic, station mode gives half of the
performance for NSS 4 capability. Configured the
hw_peer_id info in the tx descriptor as a search idx
improves the data UL traffic performances.

Signed-off-by: Karthikeyan Periyasamy <periyasa@codeaurora.org>

Index: backports-20200902_001-5.4.55-931c337125/drivers/net/wireless/ath/ath11k/core.h
===================================================================
--- backports-20200902_001-5.4.55-931c337125.orig/drivers/net/wireless/ath/ath11k/core.h
+++ backports-20200902_001-5.4.55-931c337125/drivers/net/wireless/ath/ath11k/core.h
@@ -215,6 +215,7 @@ struct ath11k_vif {
 	u32 beacon_interval;
 	u32 dtim_period;
 	u16 ast_hash;
+	u16 ast_idx;
 	u16 tcl_metadata;
 	u8 hal_addr_search_flags;
 	u8 search_type;
Index: backports-20200902_001-5.4.55-931c337125/drivers/net/wireless/ath/ath11k/dp_tx.c
===================================================================
--- backports-20200902_001-5.4.55-931c337125.orig/drivers/net/wireless/ath/ath11k/dp_tx.c
+++ backports-20200902_001-5.4.55-931c337125/drivers/net/wireless/ath/ath11k/dp_tx.c
@@ -192,6 +192,7 @@ tcl_ring_sel:
 	ti.pkt_offset = 0;
 	ti.lmac_id = ar->lmac_id;
 	ti.bss_ast_hash = arvif->ast_hash;
+	ti.bss_ast_idx = arvif->ast_idx;
 	ti.dscp_tid_tbl_idx = 0;
 
 	if (skb->ip_summed == CHECKSUM_PARTIAL &&
Index: backports-20200902_001-5.4.55-931c337125/drivers/net/wireless/ath/ath11k/hal_tx.c
===================================================================
--- backports-20200902_001-5.4.55-931c337125.orig/drivers/net/wireless/ath/ath11k/hal_tx.c
+++ backports-20200902_001-5.4.55-931c337125/drivers/net/wireless/ath/ath11k/hal_tx.c
@@ -71,6 +71,8 @@ void ath11k_hal_tx_cmd_desc_setup(struct
 	tcl_cmd->info3 = FIELD_PREP(HAL_TCL_DATA_CMD_INFO3_DSCP_TID_TABLE_IDX,
 				    ti->dscp_tid_tbl_idx) |
 			 FIELD_PREP(HAL_TCL_DATA_CMD_INFO3_SEARCH_INDEX,
+				    ti->bss_ast_idx) |
+			 FIELD_PREP(HAL_TCL_DATA_CMD_INFO3_CACHE_SET_NUM,
 				    ti->bss_ast_hash);
 	tcl_cmd->info4 = 0;
 
Index: backports-20200902_001-5.4.55-931c337125/drivers/net/wireless/ath/ath11k/hal_tx.h
===================================================================
--- backports-20200902_001-5.4.55-931c337125.orig/drivers/net/wireless/ath/ath11k/hal_tx.h
+++ backports-20200902_001-5.4.55-931c337125/drivers/net/wireless/ath/ath11k/hal_tx.h
@@ -29,6 +29,7 @@ struct hal_tx_info {
 	u32 flags1; /* %HAL_TCL_DATA_CMD_INFO2_ */
 	u16 addr_search_flags; /* %HAL_TCL_DATA_CMD_INFO0_ADDR(X/Y)_ */
 	u16 bss_ast_hash;
+	u16 bss_ast_idx;
 	u8 tid;
 	u8 search_type; /* %HAL_TX_ADDR_SEARCH_ */
 	u8 lmac_id;
Index: backports-20200902_001-5.4.55-931c337125/drivers/net/wireless/ath/ath11k/peer.c
===================================================================
--- backports-20200902_001-5.4.55-931c337125.orig/drivers/net/wireless/ath/ath11k/peer.c
+++ backports-20200902_001-5.4.55-931c337125/drivers/net/wireless/ath/ath11k/peer.c
@@ -246,6 +246,7 @@ static int ath11k_wait_for_peer_created(
 int ath11k_peer_create(struct ath11k *ar, struct ath11k_vif *arvif,
 		       struct ieee80211_sta *sta, struct peer_create_params *param)
 {
+	struct ieee80211_vif *vif = arvif->vif;
 	struct ath11k_peer *peer;
 	int ret;
 
@@ -306,7 +307,11 @@ int ath11k_peer_create(struct ath11k *ar
 
 	peer->pdev_idx = ar->pdev_idx;
 	peer->sta = sta;
-	arvif->ast_hash = peer->ast_hash;
+
+	if (vif->type == NL80211_IFTYPE_STATION) {
+		arvif->ast_hash = peer->ast_hash;
+		arvif->ast_idx = peer->hw_peer_id;
+	}
 
 	peer->sec_type = HAL_ENCRYPT_TYPE_OPEN;
 	peer->sec_type_grp = HAL_ENCRYPT_TYPE_OPEN;
